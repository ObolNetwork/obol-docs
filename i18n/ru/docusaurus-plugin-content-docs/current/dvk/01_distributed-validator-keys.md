---
Description: >-
  Для создания закрытых ключей для распределенного валидатора требуется церемония генерации распределенного ключа (DKG).
---

# Генерация ключей распределенного валидатора

## Содержание

- [Overview](#overview)
- [Actors involved](#actors-involved)
- [Cluster Definition creation](#cluster-definition-creation)
- [Carrying out the DKG ceremony](#carrying-out-the-dkg-ceremony)
- [Backing up ceremony artifacts](#backing-up-the-ceremony-artifacts)
- [Preparing for validator activation](#preparing-for-validator-activation)
- [DKG verification](#dkg-verification)
- [Appendix](#appendix)

## Обзор

Распределенный ключ валидатора — это группа закрытых ключей BLS, которые вместе действуют как пороговый ключ для участия в консенсусе Proof-of-Stake.
Чтобы сделать распределенный валидатор без отказоустойчивости (т. е. все узлы должны быть подключены к сети, чтобы подписать каждое сообщение), из-за схемы подписи BLS, используемой Proof of Stake Ethereum, каждый общий ключ может быть выбран операторами независимо. Однако для создания распределенного валидатора, который может оставаться в сети, несмотря на то, что подмножество его узлов отключается, общие ресурсы ключей необходимо генерировать вместе. (Не все 4 случайно выбранные точки на графике находятся на одной и той же кривой третьего порядка.) Чтобы сделать это безопасным способом, когда ни одна из сторон не доверяет распространение ключей, требуется так называемая церемония генерации распределенного ключа.

Клиент charon несет ответственность за безопасное завершение церемонии генерации распределенного ключа со своими узлами-контрагентами. Конфигурация церемонии описана в [определении кластера](https://docs.obol.tech/docs/dv/distributed-validator-cluster-manifest).

## Участники

В церемонии генерации распределённых ключей участвуют `Операторы` и их `клиенты Charon`.

- `Оператор` идентифицируется по адресу Ethereum. Они подпишутся закрытым ключом этого адреса, чтобы аутентифицировать своего клиента charon перед церемонией. Подпись будет; хэш открытого ключа ENR клиентов charon, `cluster_definition_hash` и увеличивающийся `nonce`, позволяющий установить прямую связь между пользователем, его клиентом charon и кластером, который этот клиент предназначен обслуживать, сохраняя при этом возможность обновить клиент charon, увеличив значение одноразового номера и переподписав его, как в стандартной спецификации ENR.

`Клиент Charon` также идентифицируется парой открытого/закрытого ключа, в данном случае открытый ключ представлен как [Запись узла Ethereum](https://eips.ethereum.org/EIPS/eip-778) (ENR). Это стандартный формат идентификации как для клиентов EL, так и для клиентов CL. Эти ENR используются каждым узлом charon для идентификации одноранговых узлов кластера через Интернет и для связи друг с другом [сквозным шифрованием](https://github.com/libp2p/go-libp2p-noise). Эти ключи должны быть созданы каждым оператором, прежде чем они смогут участвовать в создании кластера.

## Создание кластера

Этот файл определения создается с помощью [панели запуска распределенного валидатора](https://docs.obol.tech/docs/dvk/distributed_validator_launchpad). Процесс создания включает в себя несколько шагов.

- Оператор-лидер, желающий координировать создание нового кластера распределенных валидаторов, перейти на стартовую панель и выбрать "Create new Cluster"
- `Лидер` использует пользовательский интерфейс для настройки всех важных деталей кластера, включает:
  - `Адрес вывода` для созданных валидаторов
  - `feeRecipient` для предложений блокировки, если он отличается от адреса вывода.
  - Количество распределенных валидаторов для создания
  - Список участников кластера, указанный адресом Ethereum(/ENS)
  - Требуемый порог отказоустойчивости (если не выбрано безопасное значение по умолчанию)
  - Сеть (fork_version/chainId), в которой этот кластер будет проверяться
- Эти ключевые элементы информации составляют основу конфигурации кластера. Эти поля (и некоторые технические поля, такие как алгоритм DKG для использования) сериализуются для создания `cluster_definition_hash`. Этот корень merkle будет использоваться для подтверждения отсутствия двусмысленности или отклонения между определениями, когда они предоставляются узлам charon.
- Как только лидер удовлетворен в конфигурации, он публикует ее на уровне доступности данных панели запуска, чтобы другие участники могли получить к ней доступ. (На ранних стадиях разработки панель запуска будет использовать централизованную серверную базу данных для хранения конфигурации кластера. Вблизи производства такие решения, как IPFS или arweave, могут быть более подходящими для долгосрочной децентрализации панели запуска.)

- Затем лидер поделится URL-адресом этой церемонии со своими предполагаемыми участниками.
- Любой, кто откроет URL-адрес церемонии или введет `cluster_definition_hash` при появлении запроса на целевой странице, будет перенаправлен на страницу статуса церемонии. (После заполнения всех заявлений об отказе от ответственности и рекомендаций)
- Кнопка "Connect Wallet" будет видна под контейнером статуса церемонии, участник может нажать на нее, чтобы подключить свой кошелек к сайту
  - Если участник подключает кошелек, которого нет в списке участников, кнопка отключится.
  - Если участник подключает кошелек, который находится в списке участников, ему предлагается ввести ENR своего узла charon.
  - Если поле ENR заполнено и проверено, участник теперь может увидеть кнопку «Confirm Cluster Configuration». Эта кнопка запускает одну/две подписи.
    - Участник подписывает `cluster_definition_hash`, чтобы доказать, что он согласен с этой конфигурацией.
    - Участник подписывает ENR своего узла charon, чтобы аутентифицировать и авторизовать этот конкретный узел charon для участия от его имени в кластере распределенного валидатора.
  - Эти/эта подпись отправляется на уровень доступности данных, где он проверяет правильность подписи для данного адреса участника в эфире. Если подписи проходят проверку, подпись хэша определения ENR + подпись  сохраняются в объекте определения.
- Все участники в списке должны подписать хэш определения и отправить подписанный ENR до начала церемонии DKG. Неподтвержденные подписи можно легко отобразить на странице статуса.
- Наконец, после того, как все участники подписали свое одобрение и представили ENR узла charon, чтобы действовать от их имени, данные определения могут быть загружены в виде файла, если пользователи нажимают вновь отображаемую кнопку `Download Manifest`.
- На этом этапе каждый участник должен загрузить это определение в свой клиент charon, и клиент попытается выполнить DKG.

## Проведение церемонии DKG

Как только участник подготовит свой файл определения, он передаст файл команде charon `dkg`. Charon прочитает ENR, подтвердит наличие своего ENR, а затем обратится к развернутым загрузочным узлам, чтобы найти другие ENR в сети. (Свежие ENR просто имеют открытый ключ и IP-адрес 0.0.0.0 до тех пор, пока они не будут загружены в работающий клиент charon, который обновит IP-адрес, увеличит одноразовый номер ENR и подпишется с закрытым ключом клиента. Если ENR с более высоким одноразовым номером считается клиентом charon, они обновят IP-адрес этого ENR в своей адресной книге.)

Как только все клиенты в кластере смогут установить соединение друг с другом и каждый из них завершит рукопожатие (подтвердите, что у всех есть соответствующий `cluster_definition_hash`),  далее начинается церемония.

Ввод данных пользователем не требуется, charon выполняет всю работу и выводит следующие файлы на каждую машину, а затем завершает работу.

```sh
# Common data
.charon/cluster-definition.json          # Исходный файл определения из панели запуска DV или `charon create dkg`
.charon/cluster-lock.json                # Новый файл блокировки на основе cluster-definition.json с открытыми ключами группы валидаторов и пороговыми верификаторами BLS, включенными в первоначальную конфигурацию кластера
.charon/deposit-data.json         # JSON файл данных депозита для распределенных валидаторов

# Конфиденциальные данные оператора
.charon/charon-enr-private-key    # Создается до церемонии [Скопируйте и сохраните ключ]
.charon/validator_keys/           # Папка с общими ключами для резервного копирования и перемещения в клиент валидатора [Скопируйте и сохраните это]
```

## Создайте резервную копию артефактов церемонии

После завершения церемонии все участники должны сделать резервную копию созданных файлов. В будущих версиях charon, если участник потеряет доступ к этим общим ресурсам ключей, можно будет использовать протокол повторного обмена ключами, чтобы заменить старые ключи участников из распределенного валидатора на новые ключи, что позволит остальной части кластер для восстановления после набора потерянных ключевых общих ресурсов. Однако на данный момент, без резервной копии, самым безопасным было бы выйти из валидатора.

## Подготовка к активации валидатора

После завершения церемонии каждый оператор сделал безопасное резервное копирование общих ключей. Теперь они должны загрузить эти общие ресурсы в свои клиенты-валидаторы и запустить команду `charon run`, чтобы перевести их в рабочий режим.

Все операторы должны подтвердить, что в их журналах клиентов charon указано, что все узлы находятся в сети и подключены. Они также должны проверить готовность своих клиентов-маяков и клиентов-валидаторов. Панель Charon Grafana — это хороший способ увидеть готовность всего кластера с его точки зрения.

Once all operators are satisfied with network connectivity, one member can use the Obol Distributed Validator deposit flow to send the required ether and deposit data to the deposit contract, beginning the process of a distributed validator activation. Good luck.
После того, как все операторы будут удовлетворены сетевым подключением, один участник может использовать deposit flow Obol Distributed Validator для отправки необходимых данных эфира и депозита в депозитный контракт, начиная процесс активации распределенного валидатора. Удачи.

## Верификация DKG

Во многих случаях использования распределенных валидаторов спонсор/депонент валидатора может не совпадать с создателями ключей/операторами узлов, поскольку (за пределами базового протокола) делегирование доли является распространенным явлением. Эта передача информации вводит точку доверия. Как кто-то проверяет, что предлагаемые `депозитные данные` валидатора соответствуют реальным, честным DKG с участниками, которых ожидает вкладчик?

Существует ряд аспектов этой поверхности доверия, которые можно смягчить с помощью модели "Не доверяй, проверяй" ("Don't trust, verify"). В настоящее время проверка вне сети проще, пока в EVM не будут добавлены такие вещи, как [прекомпиляция BLS](https://eips.ethereum.org/EIPS/eip-2537), наряду с дешевой проверкой ZKP в цепочке. Некоторые из вопросов, которые можно задать на церемониях генерации ключей распределенного валидатора, включают:

- Объединяются ли доли открытого ключа в общий открытый ключ группы?
  - Это можно проверить в цепочке, поскольку для этого не требуется операция сопряжения.
  - Это может дать уверенность в том, что открытый ключ BLS представляет собой распределенный валидатор, но ничего не говорит о хранении ключей. (например, была ли атака sibyl на церемонии, был ли они в сговоре, чтобы восстановить закрытый ключ группы и т. д.)
- Подтверждают ли созданные открытые ключи BLS об их `cluster_definition_hash`?
  - Это делается для создания обратной связи между вновь созданными публичными ключами BLS и адресами eth1 оператора, которые принимали участие в их создании.
  - Если предложенный открытый групповой ключ распределенного валидатора BLS может создать подпись `cluster_definition_hash`, можно сделать вывод, что по крайней мере пороговое число операторов подписало эти данные.
  - Поскольку `cluster_definition_hash` один и тот же для всех распределенных валидаторов, созданных на церемонии, подписи могут быть объединены в групповую подпись, которая одновременно проверяет все созданные групповые ключи. Это удешевляет одновременную проверку нескольких валидаторов в цепочке.
- Есть ли доказательства VSS или PVSS честной церемонии DKG?
  - VSS (Verifiable Secret Sharing) означает, что только операторы могут проверить справедливость, поскольку для доказательства требуется знание одного из секретов.
  - PVSS (Publicly Verifiable Secret Sharing) означает, что любой может проверить справедливость, поскольку доказательство обычно является доказательством с нулевым разглашением (Zero Knowledge Proof).
  - PVSS справедливого DKG затруднит сговор операторов и подорвет безопасность распределенного валидатора.
  - Проверка с нулевым разглашением (Zero Knowledge Proof) в цепочке в настоящее время стоит дорого, но становится достижимой благодаря напряженной работе и исследованиям многих команд в отрасли, основанных на ZK.

## Дополнительно

### Использование DKG без панели запуска

Клиенты Charon могут выполнить DKG с файлом определения, который не содержит сигнатур оператора, если вы передадите флаг `--no-verify` в `charon dkg`. Это можно использовать в целях тестирования, когда строгая проверка подписи не имеет первостепенного значения.

### Примеры файлов конфигурации и файла блокировки

Подробности смотрите [здесь](../dv/08_distributed-validator-cluster-manifest.md#cluster-configuration-files).


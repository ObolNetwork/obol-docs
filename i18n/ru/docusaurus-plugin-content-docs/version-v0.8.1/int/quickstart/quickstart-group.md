---
sidebar_position: 5
description: Запуск одного узза в распределенном кластере валидатора с несколькими операторами
---

# Совместный запуск кластера

:::caution
Charon находится в ранней альфа-версии и не готов к запуску в основной сети
:::

Для создания распределенного кластера валидаторов с группой других операторов узлов требуется пять ключевых шагов:

- Каждый оператор подготавливает свое программное обеспечение и получает свой клиентский charon. [ENR](../faq.md#what-is-an-enr)
- Один оператор подготавливает условия генерации ключей распределенного валидатора для запуска
  - Они выбирают сеть, адрес вывода средств, количество 32 распределенных валидаторов эфира для создания и ENR каждого оператора, принимающего участие в запуске.
  - В будущем панель запуска DV будет упрощать этот процесс, с согласия на условиях, предоставленных всеми участвующими операторами.
- Каждый оператор участвует в запуске DKG, и в случае успеха создается ряд сгенерированных файлов кластера, в том числе:
  - Общий закрытый ключ для каждого распределенного валидатора
  - Файл данных депозита, содержащий детали депозита для каждого распределенного валидатора
  - Файл `cluster-lock.json`, который содержит окончательный конфиг этого кластера, необходимый для работы charon.

- Каждый оператор запускает свой узел с помощью «charon run» и использует свой мониторинг для определения работоспособности кластера и подключения
- После подтверждения работоспособности кластера файлы данных депозита, созданные в ходе этого процесса, активируются на [staking launchpad](https://launchpad.ethereum.org/).

## Начало работы с Charon

1. Склонируйте репозиторий [charon-distributed-validator-node](https://github.com/ObolNetwork/charon-distributed-validator-node) с Github, и перейдите в директорию `cd`.

   ```sh
   # Склонируйте репозиторий
   git clone https://github.com/ObolNetwork/charon-distributed-validator-node.git

   # Смените директорию
   cd charon-distributed-validator-node/
   ```
1. Затем создайте закрытый ключ для charon, чтобы использовать его для ENR.

   ```sh
   # Создайте закрытый ключ ENR (private key)
   docker run --rm -v "$(pwd):/opt/charon" ghcr.io/obolnetwork/charon:v0.8.1 create enr
   ```

   Эта команда выведет ENR вашего клиента charon в консоль. Это должно выглядеть примерно так:

   ```
   Created ENR private key: .charon/charon-enr-private-key
   enr:-JG4QAgAOXjGFcTIkXBO30aUMzg2YSo1CYV0OH8Sf2s7zA2kFjVC9ZQ_jZZItdE8gA-tUXW-rWGDqEcoQkeJ98Pw7GaGAYFI7eoegmlkgnY0gmlwhCKNyGGJc2VjcDI1NmsxoQI6SQlzw3WGZ_VxFHLhawQFhCK8Aw7Z0zq8IABksuJEJIN0Y3CCPoODdWRwgj6E
   ```

   :::caution
   На данный момент возможность замены удаленного или скомпрометированного закрытого ключа ограничена. Пожалуйста, сделайте безопасную резервную копию этого закрытого ключа, если этот распределенный валидатор важен для вас.
   :::

   Эта запись идентифицирует ваш клиент charon независимо от того, откуда он общается через Интернет. Это необходимо для следующего шага создания набора распределенных общих ключей валидатора среди операторов кластера.

   Обязательно сделайте резервную копию закрытого ключа по адресу .charon/charon-enr-private-key. Будьте осторожны, чтобы не закоммитить его в git! Если вы потеряете этот файл, вы не сможете принять участие в запуске DKG.

   Если вы принимаете участие в организованной тестовой сети Obol, отправьте созданный публичный адрес ENR (вывод консоли, начинающийся с `enr:-` (отправить вместе с enr:-), а не содержимое файла закрытого ключа) в соответствующую форму для участия.


## Генерация ключа распределенного валидатора

Чтобы безопасно создать закрытые ключи для распределенного валидатора, необходимо выполнить процесс генерации распределенного ключа (DKG).

1. После сбора всех операторов ENR и установки их в файле `.env`, один оператор должен подготовить церемонию с помощью `charon create dkg`

   ```sh

   # Сначала установите ENR всех операторов, участвующих в церемонии DKG, в файле .env как CHARON_OPERATOR_ENRS

   # Создайте .charon/cluster-definition.json для участия в церемонии DKG
   docker run --rm -v "$(pwd):/opt/charon" --env-file .env ghcr.io/obolnetwork/charon:v0.8.1 create dkg
   ```

1. Оператор, выполнивший эту команду, должен передать результирующий файл `cluster-definition.json` каждому оператору.

1. В заранее оговоренное время все операторы запускают программу церемонии с помощью команды `charon dkg`.

   ```sh
   # Скопируйте cluster-definition.json файл в .charon
   cp cluster-definition.json .charon/

   # Участие в церемонии DKG, создаст .charon/cluster-lock.json, .charon/deposit-data.json и .charon/validator_keys/
   docker run --rm -v "$(pwd):/opt/charon" ghcr.io/obolnetwork/charon:v0.8.1 dkg
   ```

## Проверка работоспособности кластера

После завершения церемонии генерации ключей узлы charon получают данные, необходимые для объединения в кластер.

1. Сначала вы должны подготовить необходимые переменные среды, в частности, вам нужно установить переменную `CHARON_BEACON_NODE_ENDPOINT`, чтобы она указывала либо на локальную, либо на удаленную конечную точку API узла маяка.

   ```sh
   # Скопируйте шаблон переменных среды
   cp .env.sample .env
   ```

   Для простоты этот репозиторий настроен для работы с удаленным узлом Beacon, например, из 
   [Infura](https://infura.io/).

   Создайте проект Eth2 и скопируйте URL-адрес `https`, убедитесь, что Prater выбран в раскрывающемся списке ENDPOINTS:

   ![Пример Infura API Endpoint](/img/example-infura-details.png)

   Замените значение `CHARON_BEACON_NODE_ENDPOINT` во вновь созданном файле `.env` этим URL-адресом.

1. Запустите узел распределенного валидатора с помощью docker-compose.
   ```sh
   # Запустите клиент charon, клиент vc и клиенты prom+grafana в контейнерах
   docker-compose up
   ```
1. Используйте предварительно подготовленную информационную панель [grafana](http://localhost:3000/) чтобы убедиться, что состояние кластера в порядке. Вы должны увидеть соединения со всеми другими операторами в кластере как работоспособные, а наблюдаемое время проверки связи для всех соединений составляет менее 1 секунды.

   ```sh
   # Откройте Grafana
   open http://localhost:3000/d/singlenode
   ```
   Если Grafana не загружает данные при первом открытии, попробуйте [этот метод](https://github.com/ObolNetwork/charon-distributed-validator-node#grafana-doesnt-load-any-data) для решения проблемы. 

## Активация распределенного валидатора

Когда кластер исправен и полностью подключен, пришло время внести необходимые 32 (тестовых) эфира, чтобы активировать недавно созданный распределенный валидатор.

1. Активируйте валидатор в тестовой сети, используя оригинальный [staking launchpad](https://prater.launchpad.ethereum.org/en/overview) сайт с данными о депозите, созданный на `.charon/deposit-data.json`.
   - Если вы используете Mac OS, `.charon`, выходная папка по умолчанию, не отображается в средстве выбора файлов найдите "Upload Deposit Data" на панели запуска. Rectify this by pressing `Command + Shift + . ` . Это должно отображать скрытые папки, позволяя вам выбрать файл депозита.
   - Более удобный интерфейс депозита для валидатора, находится в разработке для предстоящего выпуска.
1. Этот процесс занимает около 16 часов, прежде чем депозит будет зарегистрирован в цепочке маяков. Будущие обновления протокола направлены на сокращение этого времени.
1. Как только депозит валидатора распознается в цепочке маяков, валидатору присваивается индекс, и начинается ожидание активации.
1. Наконец, после активации валидатора его следует контролировать, чтобы убедиться, что он достигает расстояния включения, близкого к 0, для обеспечения оптимального вознаграждения. Вы также должны твитнуть ссылку на ваш недавно активированный валидатор с хэштегом. [#RunDVT](https://twitter.com/search?q=%2523RunDVT) 🙃

:::tip
Не забудьте быть хорошим распорядителем тестовой сети и выйти из валидатора, когда закончите тестирование.
:::
